<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рулетка</title>
    <!-- Обязательно подключаем скрипт Telegram Web Apps -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* style.css - Стили для веб-приложения рулетки */
        body {
            font-family: 'Inter', sans-serif; /* Используем Inter или другой системный шрифт */
            background-color: #006400; /* Темно-зеленый фон, как у рулеточного стола */
            color: #e0e0e0; /* Светлый текст */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Выравнивание по верху */
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden; /* Предотвращаем горизонтальный скролл */
        }

        .container {
            background-color: #008000; /* Более светлый зеленый для контейнера */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 100%;
            max-width: 1200px; /* Увеличил максимальную ширину для горизонтального расположения */
            position: relative;
            display: flex;
            flex-direction: column; /* По умолчанию колонки для мобильных */
            gap: 20px;
        }

        /* На больших экранах: располагаем колесо и стол горизонтально */
        @media (min-width: 768px) {
            .container {
                flex-direction: row; /* Ряд для больших экранов */
                align-items: flex-start;
                padding: 30px;
                flex-wrap: wrap; /* Позволяем элементам переноситься */
            }

            h1, .balance-info {
                width: 100%; /* Заголовок и баланс занимают всю ширину сверху */
            }
        }

        .game-layout {
            display: flex;
            flex-direction: column; /* По умолчанию колонки для мобильных */
            gap: 20px;
            width: 100%; /* Занимает всю ширину контейнера */
        }

        @media (min-width: 768px) {
            .game-layout {
                flex-direction: row; /* Ряд для больших экранов */
                align-items: flex-start;
            }
        }

        .game-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

            .game-column.left {
                flex: 0 0 320px; /* Фиксированная ширина для колеса */
            }

            .game-column.right {
                flex: 1; /* Оставшееся пространство для кнопок */
                min-width: 450px; /* Минимальная ширина для кнопок, чтобы поместился стол */
            }

        h1 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            text-align: center;
        }

        .balance-info {
            font-size: 1.3em;
            padding: 12px;
            background-color: #004d00;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #userBalance {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.4em;
        }

        .game-area {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
            border-radius: 50%;
            background-color: #333;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
            border: 5px solid #FFD700;
        }

        #rouletteCanvas {
            display: block;
            border-radius: 50%;
            background-color: #444;
        }

        .pointer {
            position: absolute;
            bottom: -15px; /* Указатель снизу */
            left: 50%;
            transform: translateX(-50%) rotate(180deg); /* Переворачиваем */
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #FFD700; /* Меняем на border-top */
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.7));
        }

        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 100%;
        }

        .chip-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: 100%;
            background-color: #004d00;
            padding: 10px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .chip-btn {
            background-color: #8B4513; /* Коричневый цвет фишки */
            color: white;
            padding: 10px 15px;
            border: 2px solid #FFD700; /* Золотая обводка */
            border-radius: 50%; /* Круглая форма */
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            min-width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .chip-btn.active {
                background-color: #FFD700; /* Активная фишка - золотая */
                color: #333;
                border-color: #8B4513;
                transform: scale(1.1);
                box-shadow: 0 5px 10px rgba(255, 215, 0, 0.5);
            }

            .chip-btn:hover:not(.active) {
                background-color: #A0522D;
                transform: translateY(-1px);
            }

            .chip-btn:active {
                transform: scale(0.95);
            }

            .chip-btn:disabled {
                background-color: #555;
                border-color: #444;
                cursor: not-allowed;
                opacity: 0.7;
                transform: none;
                box-shadow: none;
            }

        .custom-chip-input-container {
            display: flex;
            gap: 5px;
            width: 100%;
            max-width: 250px;
            margin-top: 5px;
        }

        .custom-chip-input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #FFD700;
            background-color: #2a2a4a;
            color: #e0e0e0;
            font-size: 1em;
            text-align: center;
        }

        .set-custom-chip-btn {
            background-color: #4CAF50;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            white-space: nowrap;
        }

            .set-custom-chip-btn:hover {
                background-color: #388E3C;
            }


        /* Общая сетка для всех типов ставок */
        .bet-type-grid {
            display: grid;
            /* 1 колонка для 0, 12 колонок для чисел, 1 колонка для 2to1 */
            grid-template-columns: 0.5fr repeat(12, 1fr) 0.5fr;
            /* 3 ряда для чисел, 1 ряд для дюжин, 1 ряд для внешних ставок */
            grid-template-rows: repeat(3, 1fr) 0.5fr 0.5fr;
            gap: 2px;
            background-color: #004d00;
            padding: 8px;
            border-radius: 10px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
            width: 100%;
            position: relative;
        }

        /* Стиль для ячейки 0 */
        .bet-number-0 {
            background-color: #4CAF50; /* Зеленый */
            grid-column: 1 / span 1;
            grid-row: 1 / span 3; /* 0 занимает 3 ряда */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            border: 1px solid #003300;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

            .bet-number-0:hover {
                background-color: #388E3C;
            }

            .bet-number-0:disabled {
                background-color: #555;
                cursor: not-allowed;
                opacity: 0.7;
            }

        /* Стили для отдельных ячеек чисел 1-36 */
        .bet-number-cell {
            padding: 8px 5px;
            font-size: 0.9em;
            background-color: #005c00; /* Базовый цвет для чисел */
            border: 1px solid #003300;
            box-shadow: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .bet-number-cell.red {
                background-color: #dc3545;
            }

            .bet-number-cell.black {
                background-color: #343a40;
            }

            .bet-number-cell:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
            }

            .bet-number-cell:disabled {
                background-color: #555;
                cursor: not-allowed;
                opacity: 0.7;
            }

        /* Кнопки "2 to 1" */
        .bet-column-label {
            background-color: #005c00;
            border: 1px solid #003300;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            padding: 5px;
            height: 100%; /* Растягиваем по высоте */
            cursor: pointer;
            position: relative;
        }

            .bet-column-label:hover:not(:disabled) {
                background-color: #007000;
            }

            .bet-column-label:disabled {
                background-color: #555;
                cursor: not-allowed;
                opacity: 0.7;
            }

        /* Дюжины */
        .dozen-row {
            grid-column: 2 / span 12; /* Занимает 12 колонок под числами */
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 колонки для дюжин */
            gap: 2px;
            width: 100%;
        }

            .dozen-row .btn {
                background-color: #17a2b8;
                border: 1px solid #003300;
                color: white;
                font-size: 0.9em;
                font-weight: bold;
                padding: 8px 5px;
                border-radius: 4px;
                max-width: none;
                cursor: pointer;
                position: relative;
            }

                .dozen-row .btn:hover:not(:disabled) {
                    background-color: #138496;
                }

                .dozen-row .btn:disabled {
                    background-color: #555;
                    cursor: not-allowed;
                    opacity: 0.7;
                }

        /* Внешние ставки (1-18, Even, Red, Black, Odd, 19-36) */
        .outside-bets-row {
            grid-column: 1 / -1; /* Занимает всю ширину грида, включая колонку 0 */
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 6 колонок */
            gap: 2px;
            width: 100%;
        }

            .outside-bets-row .btn {
                background-color: #005c00;
                border: 1px solid #003300;
                color: white;
                font-size: 0.85em;
                font-weight: bold;
                padding: 8px 5px;
                border-radius: 4px;
                max-width: none;
                cursor: pointer;
                position: relative;
            }

                .outside-bets-row .btn:hover:not(:disabled) {
                    background-color: #007000;
                }

                .outside-bets-row .btn:disabled {
                    background-color: #555;
                    cursor: not-allowed;
                    opacity: 0.7;
                }

                /* Специфичные цвета для внешних ставок */
                .outside-bets-row .btn.bet-color-red {
                    background-color: #dc3545;
                }

                .outside-bets-row .btn.bet-color-black {
                    background-color: #343a40;
                }

                .outside-bets-row .btn.bet-color-red:hover:not(:disabled) {
                    background-color: #c82333;
                }

                .outside-bets-row .btn.bet-color-black:hover:not(:disabled) {
                    background-color: #23272b;
                }

                .outside-bets-row .btn.bet-range {
                    background-color: #ffc107;
                    color: #333;
                }

                    .outside-bets-row .btn.bet-range:hover:not(:disabled) {
                        background-color: #e0a800;
                    }

                .outside-bets-row .btn.bet-parity {
                    background-color: #28a745;
                }

                    .outside-bets-row .btn.bet-parity:hover:not(:disabled) {
                        background-color: #218838;
                    }

        /* Ромбы для Красный/Черный */
        .diamond-red, .diamond-black {
            width: 15px; /* Меньший размер ромба */
            height: 15px;
            transform: rotate(45deg); /* Поворот для ромба */
            display: inline-block;
            vertical-align: middle;
            margin-right: 3px;
            border-radius: 2px; /* Слегка скругленные углы */
        }

        .diamond-red {
            background-color: #dc3545;
        }

        .diamond-black {
            background-color: #343a40;
        }

        .btn.bet-color-red span, .btn.bet-color-black span {
            transform: rotate(-45deg); /* Поворот текста обратно */
            display: inline-block;
        }

        /* Счетчик суммы ставки на кнопке */
        .bet-amount-overlay {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7em;
            padding: 2px 4px;
            border-radius: 5px;
            min-width: 20px;
            text-align: center;
            pointer-events: none; /* Не перехватывает клики */
            opacity: 0; /* Скрыт по умолчанию */
            transition: opacity 0.2s ease-in-out;
        }

            .bet-amount-overlay.visible {
                opacity: 1;
            }

        /* Анимация при добавлении фишки */
        @keyframes chip-place {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .bet-amount-overlay.animate {
            animation: chip-place 0.3s ease-out;
        }


        .message-box {
            padding: 15px;
            background-color: #004d00;
            border-radius: 10px;
            min-height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            color: #FFD700;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid #FFD700;
        }

            .message-box.error {
                color: #dc3545;
                border-color: #dc3545;
            }

            .message-box.success {
                color: #28a745;
                border-color: #28a745;
            }

        .close-btn {
            background-color: #dc3545;
        }

            .close-btn:hover {
                background-color: #c82333;
            }

        .hidden {
            display: none !important;
        }

        /* Таймер обратного отсчета */
        #countdownTimer {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            animation: pulse-countdown 1s infinite alternate; /* Анимация пульсации */
        }

        @keyframes pulse-countdown {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }


        /* Адаптивный дизайн */
        @media (max-width: 767px) { /* Для мобильных устройств */
            .container {
                padding: 15px;
                gap: 15px;
                flex-direction: column; /* Снова колонки для мобильных */
            }

            h1 {
                font-size: 1.8em;
            }

            .balance-info {
                font-size: 1.1em;
                padding: 10px;
            }

            #userBalance {
                font-size: 1.2em;
            }

            .game-column.left,
            .game-column.right {
                flex: 1; /* Возвращаем flex: 1 для мобильных */
                width: 100%;
            }

            .game-area {
                width: 240px;
                height: 240px;
            }

            .pointer {
                bottom: -12px;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 20px solid #FFD700;
            }

            .chip-btn {
                min-width: 50px;
                height: 50px;
                font-size: 0.9em;
                padding: 8px;
            }

            .bet-amount-buttons .btn {
                flex-basis: calc(50% - 4px); /* 2 кнопки в ряд для маленьких экранов */
            }

            .bet-type-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 колонки для чисел */
                gap: 1px;
                padding: 5px;
                /* Adjust grid-template-rows for mobile to stack elements correctly */
                grid-template-rows: auto; /* Let content define rows */
            }

            .bet-number-0 {
                grid-column: 1 / span 3; /* 0 занимает всю ширину на мобильных */
                grid-row: unset; /* Сброс row span */
                height: 40px; /* Фиксированная высота */
            }

            .bet-number-cell {
                /* On mobile, numbers will flow automatically in 3 columns */
                grid-column: unset !important;
                grid-row: unset !important;
                padding: 5px 2px;
                font-size: 0.75em;
            }
            /* На мобильных, 2to1 под своими колонками */
            .bet-column-label {
                grid-column: span 1 !important; /* Each 2 to 1 button takes 1 column */
                grid-row: unset !important; /* Let it flow */
                font-size: 0.8em;
            }
            /* Explicitly place 2 to 1 buttons after all numbers on mobile */
            /* This will be handled by their order of appending in JS, after all 1-36 numbers */

            .dozen-row {
                grid-column: 1 / -1; /* Full width on mobile */
                grid-template-columns: 1fr; /* Дюжины по одной в ряд на мобильных */
                grid-row: unset !important; /* Let it flow */
            }

            .outside-bets-row {
                grid-column: 1 / -1; /* Full width on mobile */
                grid-template-columns: repeat(2, 1fr); /* Внешние ставки по 2 в ряд */
                grid-row: unset !important; /* Let it flow */
            }

                .outside-bets-row .btn {
                    font-size: 0.8em;
                }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Рулетка 🎰</h1>

        <div class="balance-info">
            Ваш баланс: <span id="userBalance">0</span> SEPSTAIN
        </div>

        <div class="game-layout">
            <div class="game-column left">
                <div class="game-area">
                    <canvas id="rouletteCanvas" width="280" height="280"></canvas>
                    <div class="pointer"></div> <!-- Указатель для рулетки -->
                </div>
                <div id="countdownTimer">Следующий спин через: 10с</div>
            </div>

            <div class="game-column right">
                <div class="bet-controls" id="betAmountSelection">
                    <p>Выберите номинал фишки:</p>
                    <div class="chip-selection">
                        <button class="chip-btn" data-chip-value="100">100</button>
                        <button class="chip-btn" data-chip-value="200">200</button>
                        <button class="chip-btn" data-chip-value="500">500</button>
                        <button class="chip-btn" data-chip-value="1000">1000</button>
                        <button class="chip-btn" data-chip-value="2000">2000</button>
                        <button class="chip-btn" data-chip-value="all">Весь баланс</button>
                        <button class="chip-btn" data-chip-value="custom">Другая сумма</button>
                    </div>
                    <div class="custom-chip-input-container hidden">
                        <input type="number" id="customChipInput" class="custom-chip-input" placeholder="Введите сумму">
                        <button id="setCustomChipBtn" class="btn set-custom-chip-btn">Установить</button>
                    </div>
                </div>

                <div class="bet-controls" id="betTypeSelection">
                    <p id="currentBetAmountText">Текущая ставка: 0 SEPSTAIN</p>
                    <p>Нажмите на область, чтобы поставить фишку:</p>
                    <div class="bet-type-grid">
                        <!-- Кнопка 0 -->
                        <button class="btn bet-number-0" data-bet-type="number" data-bet-target="0">0</button>

                        <!-- Числа 1-36 и кнопки 2 to 1 будут вставлены сюда JS -->
                        <!-- Дюжины и Внешние ставки остаются в HTML, но их позиция в гриде управляется CSS -->
                        <div class="dozen-row">
                            <button class="btn bet-dozen" data-bet-type="dozen" data-bet-target="first_dozen">1st 12</button>
                            <button class="btn bet-dozen" data-bet-type="dozen" data-bet-target="second_dozen">2nd 12</button>
                            <button class="btn bet-dozen" data-bet-type="dozen" data-bet-target="third_dozen">3rd 12</button>
                        </div>

                        <div class="outside-bets-row">
                            <button class="btn bet-range" data-bet-type="range" data-bet-target="low">1 to 18</button>
                            <button class="btn bet-parity" data-bet-type="parity" data-bet-target="even">EVEN</button>
                            <button class="btn bet-color-red" data-bet-type="color" data-bet-target="red"><span class="diamond-red"></span>RED</button>
                            <button class="btn bet-color-black" data-bet-type="color" data-bet-target="black"><span class="diamond-black"></span>BLACK</button>
                            <button class="btn bet-parity" data-bet-type="parity" data-bet-target="odd">ODD</button>
                            <button class="btn bet-range" data-bet-type="range" data-bet-target="high">19 to 36</button>
                        </div>
                    </div>
                </div>

                <div id="messageBox" class="message-box"></div>

                <button id="newBetButton" class="btn full-width hidden">🎲 Сделать новую ставку</button>
                <button id="closeButton" class="btn full-width close-btn">Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        // script.js - Логика рулетки для веб-приложения

        // --- Инициализация Telegram Web App ---
        Telegram.WebApp.ready();
        Telegram.WebApp.expand(); // Разворачиваем веб-приложение на весь экран

        // --- Получение элементов DOM ---
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const userBalanceSpan = document.getElementById('userBalance');
        const betAmountSelection = document.getElementById('betAmountSelection');
        const betTypeSelection = document.getElementById('betTypeSelection');
        const chipButtons = document.querySelectorAll('.chip-btn');
        const customChipInputContainer = document.querySelector('.custom-chip-input-container');
        const customChipInput = document.getElementById('customChipInput');
        const setCustomChipBtn = document.getElementById('setCustomChipBtn');
        const messageBox = document.getElementById('messageBox');
        const newBetButton = document.getElementById('newBetButton');
        const closeButton = document.getElementById('closeButton');
        const currentBetAmountText = document.getElementById('currentBetAmountText');
        const betTypeGrid = document.querySelector('.bet-type-grid'); // Родитель для всех ставок
        const countdownTimerDisplay = document.getElementById('countdownTimer');

        // --- Параметры рулетки ---
        const numbers = [
            0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23,
            10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26
        ];
        const colors = {
            0: '#4CAF50', // Зеленый для 0
            red: '#DC3545',
            black: '#343A40'
        };

        // Определяем цвета для каждого номера (стандартная европейская рулетка)
        const numberColors = {
            0: colors[0],
            1: colors.red, 2: colors.black, 3: colors.red, 4: colors.black, 5: colors.red, 6: colors.black,
            7: colors.red, 8: colors.black, 9: colors.red, 10: colors.red, 11: colors.black, 12: colors.red,
            13: colors.black, 14: colors.red, 15: colors.black, 16: colors.red, 17: colors.black, 18: colors.red,
            19: colors.red, 20: colors.black, 21: colors.red, 22: colors.black, 23: colors.red, 24: colors.black,
            25: colors.red, 26: colors.black, 27: colors.red, 28: colors.red, 29: colors.black, 30: colors.red,
            31: colors.black, 32: colors.red, 33: colors.black, 34: colors.red, 35: colors.black, 36: colors.red
        };

        const numSegments = numbers.length;
        const segmentAngle = (2 * Math.PI) / numSegments;
        const radius = canvas.width / 2;

        let currentRotation = 0; // Текущий угол вращения колеса
        let animationFrameId;
        let isSpinning = false;

        let selectedChipValue = 100; // По умолчанию выбранная фишка
        let activeBets = {}; // { 'betType:betTarget': totalAmountOnThisBet }
        let totalBetsCount = 0; // Количество отдельных фишек, поставленных за раунд
        const MAX_BETS_PER_ROUND = 10;

        const SPIN_INTERVAL_SECONDS = 10;
        let spinCountdown = SPIN_INTERVAL_SECONDS;
        let countdownIntervalId;

        // --- Функции отрисовки рулетки ---

        /**
         * Отрисовывает колесо рулетки.
         */
        function drawRoulette() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Очищаем канвас

            ctx.save();
            ctx.translate(radius, radius); // Перемещаем начало координат в центр
            ctx.rotate(currentRotation); // Применяем вращение

            for (let i = 0; i < numSegments; i++) {
                const startAngle = i * segmentAngle;
                const endAngle = (i + 1) * segmentAngle;
                const number = numbers[i];
                const color = numberColors[number];

                ctx.beginPath();
                ctx.arc(0, 0, radius, startAngle, endAngle);
                ctx.lineTo(0, 0);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#222'; // Разделители сегментов
                ctx.lineWidth = 2;
                ctx.stroke();

                // Отрисовка номера
                ctx.save();
                ctx.rotate(startAngle + segmentAngle / 2); // Поворачиваем для текста
                ctx.textAlign = 'right';
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(number.toString(), radius * 0.8, 5); // Смещаем текст к краю
                ctx.restore();
            }

            ctx.restore(); // Восстанавливаем состояние канваса

            // Отрисовка центрального круга
            ctx.beginPath();
            ctx.arc(radius, radius, radius * 0.15, 0, 2 * Math.PI);
            ctx.fillStyle = '#1a1a2e'; // Темный цвет центра
            ctx.fill();
            ctx.strokeStyle = '#FFD700'; // Золотая обводка
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        /**
         * Подсвечивает выигрышный номер на колесе рулетки.
         * @param {number} winningNumber - Выигравший номер.
         */
        function highlightWinningNumber(winningNumber) {
            const index = numbers.indexOf(winningNumber);
            if (index === -1) return;

            // Вычисляем угол выигрышного сектора относительно текущего вращения
            // Это нужно, чтобы свечение появлялось на правильном месте после остановки колеса
            const winningSectorStartAngle = (index * segmentAngle);
            const winningSectorEndAngle = ((index + 1) * segmentAngle);

            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(currentRotation); // Применяем текущее вращение канваса

            // Анимация свечения
            let glowRadius = radius * 0.9; // Начинаем свечение чуть внутри
            let glowAlpha = 0.5;
            const maxGlowRadius = radius * 1.1; // Максимальный радиус свечения
            const glowDuration = 1000; // Длительность свечения в мс
            const glowStartTime = performance.now();

            function animateGlow(currentTime) {
                const elapsed = currentTime - glowStartTime;
                const progress = Math.min(elapsed / glowDuration, 1);

                // Затухание свечения
                glowAlpha = 0.5 * (1 - progress);
                // Расширение свечения
                glowRadius = radius * 0.9 + (maxGlowRadius - radius * 0.9) * progress;

                // Очищаем только область колеса, чтобы перерисовать свечение
                ctx.clearRect(-radius, -radius, canvas.width, canvas.height);
                drawRoulette(); // Перерисовываем колесо без свечения

                ctx.beginPath();
                ctx.arc(0, 0, glowRadius, winningSectorStartAngle, winningSectorEndAngle);
                ctx.lineTo(0, 0);
                ctx.closePath();
                ctx.fillStyle = `rgba(255, 255, 0, ${glowAlpha})`; // Желтое свечение
                ctx.fill();

                if (progress < 1) {
                    requestAnimationFrame(animateGlow);
                } else {
                    drawRoulette(); // Финальная отрисовка без свечения
                }
            }
            requestAnimationFrame(animateGlow);
            ctx.restore();
        }


        // --- Управление балансом и сообщениями ---

        /**
         * Обновляет отображение баланса пользователя.
         * @param {number} balance - Новый баланс.
         */
        function updateBalanceDisplay(balance) {
            userBalanceSpan.textContent = balance;
        }

        /**
         * Отображает сообщение в информационном блоке.
         * @param {string} message - Текст сообщения.
         * @param {string} type - Тип сообщения ('success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box'; // Сброс классов
            if (type === 'success') {
                messageBox.classList.add('success');
            } else if (type === 'error') {
                messageBox.classList.add('error');
            }
        }

        /**
         * Обновляет отображение общей суммы ставок на кнопках.
         * @param {string} betKey - Ключ ставки (например, 'number:15').
         */
        function updateBetAmountOverlay(betKey) {
            const button = document.querySelector(`[data-bet-type="${betKey.split(':')[0]}"][data-bet-target="${betKey.split(':')[1]}"]`);
            if (button) {
                let overlay = button.querySelector('.bet-amount-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.classList.add('bet-amount-overlay');
                    button.appendChild(overlay);
                }
                overlay.textContent = activeBets[betKey] > 0 ? activeBets[betKey] : '';
                overlay.classList.toggle('visible', activeBets[betKey] > 0);

                // Анимация при добавлении фишки
                overlay.classList.remove('animate');
                void overlay.offsetWidth; // Trigger reflow
                overlay.classList.add('animate');
            }
        }

        /**
         * Очищает все отображения ставок на кнопках.
         */
        function clearAllBetAmountOverlays() {
            document.querySelectorAll('.bet-amount-overlay').forEach(overlay => {
                overlay.textContent = '';
                overlay.classList.remove('visible', 'animate');
            });
        }

        // --- Логика игры ---

        /**
         * Отправляет данные боту через Telegram Web App.
         * @param {object} data - Объект с данными для отправки.
         */
        function sendDataToBot(data) {
            Telegram.WebApp.sendData(JSON.stringify(data));
        }

        /**
         * Запускает анимацию вращения рулетки и определяет результат.
         */
        function spinWheel() {
            if (isSpinning) {
                return;
            }
            if (totalBetsCount === 0) {
                showMessage('Сделайте хотя бы одну ставку для спина!', 'error');
                startCountdown(); // Перезапускаем таймер, если ставок нет
                return;
            }

            isSpinning = true;
            disableAllBetButtons(); // Отключаем все кнопки ставок
            clearInterval(countdownIntervalId); // Останавливаем таймер обратного отсчета
            countdownTimerDisplay.textContent = 'Крутим...';

            showMessage('Крутим колесо... ⚙️');

            // Случайное число для остановки (индекс в массиве numbers)
            const winningIndex = Math.floor(Math.random() * numSegments);
            const winningNumber = numbers[winningIndex];

            // Угол, на который должно остановиться колесо
            // Добавляем несколько полных оборотов для эффекта вращения
            const targetAngle = (2 * Math.PI - ((winningIndex * segmentAngle) + (segmentAngle / 2))) + (5 * 2 * Math.PI); // 5 полных оборотов

            const duration = 5000; // Длительность анимации в мс
            const startTime = performance.now();

            function animateSpin(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // Прогресс от 0 до 1

                // Использование функции замедления (ease-out quint)
                const easedProgress = 1 - Math.pow(1 - progress, 5);

                currentRotation = (easedProgress * targetAngle) % (2 * Math.PI);
                drawRoulette();

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animateSpin);
                } else {
                    // Анимация завершена
                    isSpinning = false;

                    highlightWinningNumber(winningNumber); // Подсвечиваем выигрышный номер

                    // Отправляем все сделанные ставки и выигрышное число боту
                    sendDataToBot({
                        type: 'roulette_round_result',
                        bets: Object.keys(activeBets).map(key => {
                            const [betType, betTarget] = key.split(':');
                            return { betAmount: activeBets[key], betType, betTarget: isNaN(parseInt(betTarget)) ? betTarget : parseInt(betTarget) };
                        }),
                        winningNumber: winningNumber
                    });

                    // Очищаем ставки для нового раунда
                    activeBets = {};
                    totalBetsCount = 0;
                    clearAllBetAmountOverlays();

                    // Бот отправит обновленный баланс и сообщение о результате.
                    // После получения ответа от бота, мы запустим новый отсчет.
                }
            }

            animationFrameId = requestAnimationFrame(animateSpin);
        }

        /**
         * Отключает все кнопки выбора ставки и фишек.
         */
        function disableAllBetButtons() {
            chipButtons.forEach(btn => btn.disabled = true);
            document.querySelectorAll('.bet-type-grid .btn').forEach(btn => btn.disabled = true);
            setCustomChipBtn.disabled = true;
            customChipInput.disabled = true;
        }

        /**
         * Включает все кнопки выбора ставки и фишек.
         */
        function enableAllBetButtons() {
            chipButtons.forEach(btn => btn.disabled = false);
            document.querySelectorAll('.bet-type-grid .btn').forEach(btn => btn.disabled = false);
            setCustomChipBtn.disabled = false;
            customChipInput.disabled = false;
        }

        /**
         * Запускает таймер обратного отсчета до следующего спина.
         */
        function startCountdown() {
            spinCountdown = SPIN_INTERVAL_SECONDS;
            countdownTimerDisplay.textContent = `Следующий спин через: ${spinCountdown}с`;
            enableAllBetButtons(); // Включаем кнопки для ставок

            countdownIntervalId = setInterval(() => {
                spinCountdown--;
                countdownTimerDisplay.textContent = `Следующий спин через: ${spinCountdown}с`;

                if (spinCountdown <= 0) {
                    clearInterval(countdownIntervalId);
                    spinWheel(); // Запускаем колесо
                }
            }, 1000);
        }

        // --- Обработчики событий ---

        // Выбор номинала фишки
        chipButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Снимаем активность со всех фишек
                chipButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active'); // Активируем выбранную фишку

                let value = button.dataset.chipValue;
                if (value === 'all') {
                    selectedChipValue = parseFloat(userBalanceSpan.textContent);
                    if (isNaN(selectedChipValue) || selectedChipValue <= 0) {
                        showMessage('Ваш баланс слишком мал для ставки "Весь баланс".', 'error');
                        button.classList.remove('active'); // Снимаем активность, если баланс 0
                        selectedChipValue = 0; // Сбрасываем выбранную фишку
                        return;
                    }
                } else if (value === 'custom') {
                    customChipInputContainer.classList.remove('hidden');
                    customChipInput.focus();
                    selectedChipValue = 0; // Сбрасываем, пока не введут
                    return; // Не устанавливаем selectedChipValue пока пользователь не введет
                } else {
                    selectedChipValue = parseFloat(value);
                }
                customChipInputContainer.classList.add('hidden'); // Скрываем поле ввода, если выбрана фиксированная фишка
                showMessage(`Выбран номинал фишки: ${selectedChipValue} SEPSTAIN.`);
            });
        });

        // Установка кастомного номинала фишки
        setCustomChipBtn.addEventListener('click', () => {
            let customValue = parseFloat(customChipInput.value);
            if (isNaN(customValue) || customValue <= 0) {
                showMessage('Пожалуйста, введите корректную сумму для фишки (число больше 0).', 'error');
                return;
            }
            selectedChipValue = customValue;
            // Снимаем активность со всех фишек, кроме "Другая сумма"
            chipButtons.forEach(btn => {
                if (btn.dataset.chipValue !== 'custom') {
                    btn.classList.remove('active');
                }
            });
            document.querySelector('.chip-btn[data-chip-value="custom"]').classList.add('active');
            showMessage(`Выбран номинал фишки: ${selectedChipValue} SEPSTAIN.`);
            // customChipInputContainer.classList.add('hidden'); // Можно скрыть после установки
        });


        // Общий обработчик для всех кнопок ставок (числа, дюжины, колонки, цвета, чет/нечет, диапазоны)
        function handleBetAreaClick(event) {
            if (isSpinning) {
                showMessage('Дождитесь завершения текущего вращения!', 'info');
                return;
            }
            if (selectedChipValue <= 0) {
                showMessage('Пожалуйста, выберите номинал фишки.', 'error');
                return;
            }
            if (totalBetsCount >= MAX_BETS_PER_ROUND) {
                showMessage(`Вы достигли лимита в ${MAX_BETS_PER_ROUND} ставок за раунд!`, 'error');
                // Не отключаем кнопки, чтобы пользователь мог убрать фишки, если передумает
                return;
            }
            if (selectedChipValue > parseFloat(userBalanceSpan.textContent)) {
                showMessage(`Недостаточно средств для ставки ${selectedChipValue} SEPSTAIN. Ваш баланс: ${userBalanceSpan.textContent} SEPSTAIN.`, 'error');
                return;
            }

            const button = event.currentTarget;
            const betType = button.dataset.betType;
            const betTarget = button.dataset.betTarget;
            const betKey = `${betType}:${betTarget}`;

            // Добавляем ставку
            activeBets[betKey] = (activeBets[betKey] || 0) + selectedChipValue;
            totalBetsCount++;
            updateBetAmountOverlay(betKey); // Обновляем отображение суммы на кнопке

            // Обновляем баланс в UI (списываем фишку)
            updateBalanceDisplay(parseFloat(userBalanceSpan.textContent) - selectedChipValue);

            showMessage(`Поставлено ${selectedChipValue} на ${button.textContent.trim()}. Всего ставок: ${totalBetsCount}/${MAX_BETS_PER_ROUND}.`);

            // Если достигнут лимит ставок, сообщаем об этом
            if (totalBetsCount >= MAX_BETS_PER_ROUND) {
                showMessage(`Лимит ставок (${MAX_BETS_PER_ROUND}) достигнут! Ожидайте следующего спина.`, 'info');
                // disableAllBetButtons(); // Не отключаем, чтобы можно было снять фишки
            }
        }

        // Привязываем обработчики ко всем кнопкам ставок
        function attachBetAreaListeners() {
            // Удаляем старые, чтобы избежать дублирования, если функция вызывается повторно
            document.querySelectorAll('.bet-type-grid .btn').forEach(button => {
                button.removeEventListener('click', handleBetAreaClick);
            });
            // Привязываем новые
            document.querySelectorAll('.bet-type-grid .btn').forEach(button => {
                button.addEventListener('click', handleBetAreaClick);
            });
        }

        closeButton.addEventListener('click', () => {
            Telegram.WebApp.close(); // Закрываем веб-приложение
        });

        // --- Инициализация при загрузке ---
        document.addEventListener('DOMContentLoaded', () => {
            drawRoulette(); // Первая отрисовка колеса
            createBettingGridButtons(); // Создаем все кнопки ставок
            attachBetAreaListeners(); // Привязываем обработчики к новым кнопкам

            // Активируем фишку по умолчанию (100)
            document.querySelector('.chip-btn[data-chip-value="100"]').classList.add('active');
            showMessage(`Выберите номинал фишки: ${selectedChipValue} SEPSTAIN.`);

            // Запрашиваем начальный баланс у бота
            sendDataToBot({ type: 'request_initial_data' });
        });

        // Обработка данных, приходящих от бота (обновленный баланс после спина)
        Telegram.WebApp.onEvent('messageFromBot', (event) => {
            const data = JSON.parse(event.data); // Парсим JSON-строку
            console.log('Получены данные от бота:', data);

            if (data.type === 'initial_data') {
                updateBalanceDisplay(data.balance);
                showMessage(`Добро пожаловать! Ваш баланс: ${data.balance} SEPSTAIN.`, 'success');
                startCountdown(); // Запускаем таймер обратного отсчета после получения баланса
            } else if (data.type === 'roulette_spin_result') {
                // Это сообщение от бота после обработки спина, показываем его
                updateBalanceDisplay(data.finalBalance); // Обновляем баланс
                showMessage(data.message, data.outcome === 'win' ? 'success' : 'error');
                startCountdown(); // Запускаем новый отсчет после получения результата
            }
        });

        // --- Динамическое создание кнопок для всей сетки ставок ---
        function createBettingGridButtons() {
            // Удаляем все динамически созданные кнопки перед пересозданием
            document.querySelectorAll('.bet-number-cell, .bet-column-label').forEach(btn => btn.remove());

            // Numbers in visual order for the 3 rows and 12 columns
            // Row 1: 3, 6, 9, ..., 36
            // Row 2: 2, 5, 8, ..., 35
            // Row 3: 1, 4, 7, ..., 34
            const numbersLayout = [
                // Row 1 (top)
                [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36],
                // Row 2 (middle)
                [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35],
                // Row 3 (bottom)
                [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34]
            ];

            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 12; col++) {
                    const number = numbersLayout[row][col];
                    const button = document.createElement('button');
                    button.classList.add('btn', 'bet-number-cell');
                    button.textContent = number;
                    button.dataset.betType = 'number';
                    button.dataset.betTarget = number;

                    // Apply red/black color
                    const colorClass = numberColors[number] === colors.red ? 'red' : 'black';
                    button.classList.add(colorClass);

                    // Set grid position for desktop layout
                    button.style.gridColumn = `${col + 2} / span 1`; // +2 because of 0 column (col 1)
                    button.style.gridRow = `${row + 1} / span 1`;

                    betTypeGrid.appendChild(button);
                }
            }

            // Create 2 to 1 buttons
            for (let i = 1; i <= 3; i++) {
                const button = document.createElement('button');
                button.classList.add('btn', 'bet-column-label');
                button.textContent = '2 to 1';
                button.dataset.betType = 'column';
                button.dataset.betTarget = `col${i}`;
                button.style.gridColumn = '14 / span 1'; // Last column
                button.style.gridRow = `${i} / span 1`; // Row 1, 2, 3
                betTypeGrid.appendChild(button);
            }

            // Ensure existing dozen and outside bets are correctly positioned by CSS Grid
            // They are already in HTML, just need to make sure their grid properties are applied
            // (These are set in the CSS directly for .dozen-row and .outside-bets-row)
        }
    </script>
</body>
</html>
